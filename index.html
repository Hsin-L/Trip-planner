<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Planner</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.08);
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(900px 600px at 100% 10%, rgba(52,211,153,.14), transparent 55%),
        radial-gradient(800px 700px at 60% 120%, rgba(251,191,36,.10), transparent 55%),
        var(--bg);
      color: var(--text);
    }

    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .title{
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-width: 260px;
    }

    .titleRow{
      display:flex;
      align-items: center;
      gap: 10px;
    }

    h1{
      margin:0;
      font-size: 28px;
      letter-spacing: .2px;
      line-height: 1.15;
    }
    @media (max-width: 900px){
      h1{ font-size: 22px; }
    }

    .sub{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .toolbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    .field{
      display:flex;
      align-items:center;
      gap:8px;
      background: rgba(17,24,39,.7);
      border: 1px solid var(--line);
      padding: 8px 10px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .field input[type="text"]{
      width: 220px;
      max-width: 60vw;
      border:0;
      outline:0;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }
    .field input[type="checkbox"]{
      transform: translateY(0.5px);
      accent-color: var(--accent);
    }

    button{
      cursor:pointer;
      border: 1px solid var(--line);
      background: rgba(17,24,39,.7);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-size: 13px;
      box-shadow: var(--shadow);
    }
    button:hover{ border-color: rgba(96,165,250,.5); }

    .btnSmall{
      padding: 7px 10px;
      font-size: 12px;
      border-radius: 10px;
      box-shadow: none;
    }
    .btnDanger{ border-color: rgba(251,113,133,.35); }
    .btnDanger:hover{ border-color: rgba(251,113,133,.7); }
    .btnAccent{ border-color: rgba(96,165,250,.35); }
    .btnAccent:hover{ border-color: rgba(96,165,250,.7); }

    .iconBtn{
      width: 34px;
      height: 34px;
      padding: 0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
      background: rgba(17,24,39,.7);
      font-size: 14px;
      user-select: none;
    }
    .iconBtn:hover{ border-color: rgba(96,165,250,.55); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.85));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap:10px;
    }
    .cardHead h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
      color: #dbeafe;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .cardBody{ padding: 12px 14px; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: rgba(31,41,55,.7);
      border: 1px solid var(--line);
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: #d1d5db;
      white-space: nowrap;
    }
    .chip.fixed{ border-color: rgba(96,165,250,.4); color:#bfdbfe; }
    .chip.flex{ border-color: rgba(251,191,36,.35); color:#fde68a; }
    .chip.hotel{ border-color: rgba(52,211,153,.35); color:#bbf7d0; }
    .chip.flight{ border-color: rgba(248,113,113,.35); color:#fecaca; }
    .chip.transport{ border-color: rgba(125,211,252,.25); color:#cffafe; }
    .chip.reminder{ border-color: rgba(167,139,250,.30); color:#e9d5ff; }
    .chip.food{ border-color: rgba(251,146,60,.35); color:#fed7aa; }
    .chip.visit{ border-color: rgba(45,212,191,.30); color:#ccfbf1; }
    .chip.rule{ border-color: rgba(244,114,182,.30); color:#fbcfe8; }

    details.day{
      border-top: 1px solid rgba(255,255,255,.04);
    }
    details.day:first-of-type{ border-top: 0; }

    details.day > summary{
      list-style: none;
      cursor: pointer;
      padding: 14px 14px;
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap:10px;
      user-select: none;
    }
    details.day > summary::-webkit-details-marker{ display:none; }

    .dayTitle{
      display:flex;
      align-items: center;
      gap:10px;
      min-width: 0;
    }

    .dayTitle .d{
      font-family: var(--mono);
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #dbeafe;
      padding: 5px 12px;
      border: 1px solid rgba(96,165,250,.55);
      border-radius: 999px;
      background:
        radial-gradient(120px 50px at 20% 50%, rgba(96,165,250,.35), transparent 70%),
        rgba(30,58,138,.22);
      flex: 0 0 auto;
    }

    .dayTitle .t{
      font-weight: 750;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 55vw;
    }

    .dayMeta{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items: center;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .items{
      padding: 0 14px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .item{
      border: 1px solid var(--line);
      background: rgba(17,24,39,.55);
      border-radius: 12px;
      padding: 10px;
      display:grid;
      grid-template-columns: 170px 1fr;
      gap: 10px;
    }

    .time{
      font-family: var(--mono);
      font-size: 12px;
      color: #e0f2fe;
      line-height: 1.35;
      min-width: 0;
    }
    .time .small{ color: var(--muted); font-size: 11px; display:block; margin-top:6px; }

    .main{
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    .row1{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap:10px;
    }

    .text{
      font-size: 13.5px;
      line-height: 1.5;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .badges{ display:flex; flex-wrap: wrap; gap: 6px; justify-content:flex-end; }

    .row2{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      flex-wrap: wrap;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .actions input[type="checkbox"]{ accent-color: var(--good); }

    .notePreview{
      color: rgba(156,163,175,.95);
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      border-left: 2px solid rgba(255,255,255,.08);
      padding-left: 10px;
      margin-top: 2px;
    }

    .muted{ color: var(--muted); }

    .twoCol{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .twoCol{ grid-template-columns: 1fr; }
      .item{ grid-template-columns: 1fr; }
      .dayTitle .t{ max-width: 70vw; }
    }

    .footerHint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
    }

    .headBtns{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    /* ===== Modal (<dialog>) ===== */
    dialog{
      width: min(760px, 92vw);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 0;
      background: linear-gradient(180deg, rgba(17,24,39,.98), rgba(15,23,42,.98));
      color: var(--text);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
    }
    dialog::backdrop{
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(2px);
    }
    .modalHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .modalHead .mh{
      font-size: 14px;
      font-weight: 800;
      color: #dbeafe;
      letter-spacing: .2px;
      margin: 0;
    }
    .modalBody{
      padding: 12px 14px 6px;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap: 10px 12px;
      align-items: start;
    }
    @media (max-width: 720px){
      .modalGrid{ grid-template-columns: 1fr; }
    }
    .mlabel{
      color: var(--muted);
      font-size: 12px;
      padding-top: 9px;
    }
    .minput, .mselect, .mtextarea{
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(15,23,42,.65);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      outline: none;
      font-size: 13px;
      font-family: var(--sans);
    }
    .mtextarea{
      min-height: 84px;
      resize: vertical;
      line-height: 1.5;
    }
    .mrow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      padding-top: 6px;
    }
    .mrow label{
      color: var(--muted);
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select: none;
    }
    .mrow input[type="checkbox"]{ accent-color: var(--accent); }
    .modalFoot{
      padding: 10px 14px 14px;
      display:flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.06);
    }

    .mapBtn{
      width: 34px;
      height: 34px;
      padding: 0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      border: 1px solid rgba(96,165,250,.25);
      background: rgba(17,24,39,.55);
      color: #bfdbfe;
      box-shadow: none;
      font-size: 14px;
    }
    .mapBtn:hover{ border-color: rgba(96,165,250,.6); }

    @media print{
      body{ background: #fff; color: #111; }
      .wrap{ max-width: 100%; padding: 0; }
      header, .toolbar, .field, button, dialog{ display:none !important; }
      .card{ box-shadow: none; border: 1px solid #ddd; }
      .cardHead{ border-bottom: 1px solid #ddd; }
      .item{ border: 1px solid #e5e7eb; background: #fff; }
      a{ color: #111; text-decoration: underline; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="titleRow">
          <h1 id="titleText">Trip Planner</h1>
          <button id="editMetaTop" class="iconBtn" type="button" title="ç·¨è¼¯æ—…éŠè¨­å®š" aria-label="ç·¨è¼¯æ—…éŠè¨­å®š">âš™ï¸</button>
        </div>
        <div class="sub" id="subtitleText">ç´”å‰ç«¯å–®æª”ï¼šå¯æœå°‹ã€å¯å‹¾é¸å®Œæˆã€å¯å¯«å‚™è¨»ã€å¯æ–°å¢/åˆªé™¤ä¸¦è‡ªå‹•ä¿å­˜ã€‚</div>
      </div>

      <div class="toolbar">
        <div class="field">
          <label for="q">æœå°‹</label>
          <input id="q" type="text" placeholder="è¼¸å…¥ï¼šè¥¿æ¹– / HKG / å¤œå¸‚ / é£¯åº—..." />
        </div>
        <div class="field">
          <label><input id="onlyFixed" type="checkbox" /> åªçœ‹å›ºå®š</label>
        </div>
        <div class="field">
          <label><input id="onlyFlex" type="checkbox" /> åªçœ‹å½ˆæ€§</label>
        </div>
        <div class="field">
          <label><input id="onlyTodo" type="checkbox" /> åªçœ‹æœªå®Œæˆ</label>
        </div>
        <button id="expandAll" type="button">å…¨éƒ¨å±•é–‹</button>
        <button id="collapseAll" type="button">å…¨éƒ¨æ”¶èµ·</button>
        <button id="print" type="button">åˆ—å° / å­˜ PDF</button>
        <button id="resetDoneNote" type="button">æ¸…ç©ºå‹¾é¸/å‚™è¨»</button>
        <button id="resetAll" class="btnDanger" type="button">é‡è¨­å…¨éƒ¨</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="cardHead">
          <h2>
            æ—…éŠè¨­å®šï¼ˆæ—¥æœŸ / åœ°é» / æ¨™é¡Œï¼‰
            <button id="editMetaCard" class="iconBtn" type="button" title="ç·¨è¼¯" aria-label="ç·¨è¼¯æ—…éŠè¨­å®š">âœ</button>
          </h2>
          <div class="muted" style="font-size:12px;">å„²å­˜å¾Œæœƒè‡ªå‹•è£œé½Šæ¯æ—¥æ—¥æœŸå€å¡Š</div>
        </div>
        <div class="cardBody" id="settings"></div>
      </section>

      <section class="card">
        <div class="cardHead">
          <h2>äº¤é€šèˆ‡ä½å®¿ï¼ˆèˆªç­ / äº¤é€š / ä½å®¿ï¼‰</h2>
          <div class="headBtns">
            <button id="addFixed" class="btnSmall btnAccent" type="button">ï¼‹æ–°å¢</button>
          </div>
        </div>
        <div class="cardBody" id="fixedList"></div>
      </section>

      <section class="card">
        <div class="cardHead">
          <h2 id="daysTitle">æ¯æ—¥è¡Œç¨‹</h2>
          <div class="muted" style="font-size:12px;">ç”¨ <details>/<summary> å¿«é€Ÿå±•é–‹/æ”¶èµ·æ•´å¤©</div>
        </div>
        <div id="days"></div>
      </section>

      <section class="card">
        <div class="cardHead">
          <h2>æé†’äº‹é …</h2>
          <div class="headBtns">
            <button id="addReminder" class="btnSmall btnAccent" type="button">ï¼‹æ–°å¢</button>
          </div>
        </div>
        <div class="cardBody" id="reminders"></div>
      </section>

      <section class="card">
        <div class="cardHead">
          <h2>é¤å»³æ¸…å–®</h2>
          <div class="headBtns">
            <button id="addRestaurant" class="btnSmall btnAccent" type="button">ï¼‹æ–°å¢</button>
          </div>
        </div>
        <div class="cardBody" id="food"></div>
      </section>
    </div>
  </div>

  <!-- ===== Reusable Modal ===== -->
  <dialog id="modal">
    <form id="modalForm" method="dialog">
      <div class="modalHead">
        <h3 class="mh" id="modalTitle">ç·¨è¼¯</h3>
        <button class="iconBtn" type="button" id="modalClose" aria-label="é—œé–‰">âœ•</button>
      </div>
      <div class="modalBody">
        <div class="modalGrid" id="modalFields"></div>
      </div>
      <div class="modalFoot">
        <button type="button" id="modalCancel">å–æ¶ˆ</button>
        <button type="submit" class="btnAccent" id="modalSave">å„²å­˜</button>
      </div>
    </form>
  </dialog>

<script>
  const KEY_DATA = "trip_planner_frontend_v3_date_time_maps";

  function uid(prefix="id"){
    return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`;
  }

  const DEFAULT_DATA = {
    meta: {
      title: "10/27â€“11/1 è¡Œç¨‹è¡¨ï¼ˆæ­å·ãƒ»è˜‡å·ãƒ»ä¸Šæµ·ï¼‰",
      start: "2026-10-27",
      end: "2026-11-01",
      locations: ["æ­å·","è˜‡å·","ä¸Šæµ·"]
    },
    fixed: [
      { id: uid("fx"), dateText:"10/27ï¼ˆäºŒï¼‰", kind:"èˆªç­", text:"HX253ï¼šTPE 11:50 â†’ HKG 13:55", type:"flight", fixed:true, done:false, note:"", map:"" },
      { id: uid("fx"), dateText:"10/27ï¼ˆäºŒï¼‰", kind:"èˆªç­", text:"HX128ï¼šHKG 21:25 â†’ HGH 23:40", type:"flight", fixed:true, done:false, note:"", map:"" },
      { id: uid("fx"), dateText:"11/1ï¼ˆæ—¥ï¼‰", kind:"èˆªç­", text:"BR711ï¼šPVG 13:15 â†’ TPE 15:15", type:"flight", fixed:true, done:false, note:"", map:"" },
      { id: uid("fx"), dateText:"10/27â€“10/29", kind:"ä½å®¿", text:"æ­å·æœ¨è˜­é“é£¯åº—ï¼ˆæ²³åŠè¡—åº—ï¼‰2æ™š", type:"hotel", fixed:true, done:false, note:"", map:"" }
    ],
    days: [], // æœƒä¾ meta.start/end è‡ªå‹•å»ºç«‹
    reminders: [
      { id: uid("rm"), text:"æŠŠè­·ç…§/ç°½è­‰/ä¿éšªç¢ºèªä¸€é", fixed:true, type:"reminder", done:false, note:"", map:"" }
    ],
    restaurants: [
      { id: uid("rs"), city:"æ­å·", name:"å››ç¶å…’ç§æˆ¿èœ", fixed:false, type:"food", done:false, note:"", map:"" }
    ],
    restaurantsNote: ""
  };

  function loadData(){
    try{
      const raw = localStorage.getItem(KEY_DATA);
      if(!raw){
        localStorage.setItem(KEY_DATA, JSON.stringify(DEFAULT_DATA));
        const d0 = structuredClone(DEFAULT_DATA);
        syncDaysToMetaRange(d0, {preserveExisting:true});
        saveData(d0);
        return d0;
      }
      const d = JSON.parse(raw);
      if(!d || typeof d !== "object") throw new Error("bad data");
      // Ensure days exist
      syncDaysToMetaRange(d, {preserveExisting:true});
      return d;
    }catch(e){
      const d0 = structuredClone(DEFAULT_DATA);
      syncDaysToMetaRange(d0, {preserveExisting:true});
      return d0;
    }
  }
  function saveData(d){
    localStorage.setItem(KEY_DATA, JSON.stringify(d));
  }

  function typeLabel(type){
    return ({
      flight:"èˆªç­", hotel:"ä½å®¿", transport:"äº¤é€š", food:"åƒé£¯", visit:"æ™¯é»", rule:"è¦å‰‡",
      reminder:"æé†’", other:"å…¶ä»–"
    })[type] || "é …ç›®";
  }
  function typeChipClass(type){
    return ({
      flight:"flight", hotel:"hotel", transport:"transport", food:"food", visit:"visit", rule:"rule", reminder:"reminder"
    })[type] || "";
  }
  function chipEl(text, cls){
    const span = document.createElement("span");
    span.className = `chip ${cls||""}`.trim();
    span.textContent = text;
    return span;
  }
  function confirmDanger(msg){ return window.confirm(msg); }
  function sanitizeLocationsInput(s){
    return (s||"")
      .split(/[ï¼Œ,]/g)
      .map(x=>x.trim())
      .filter(Boolean);
  }
  function formatDateRange(meta){
    const loc = (meta.locations||[]).filter(Boolean).join("ãƒ»");
    const range = (meta.start && meta.end) ? `${meta.start} â†’ ${meta.end}` : "";
    return `${range}${loc ? " ï½œ " + loc : ""}`.trim();
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ===== Date helpers =====
  const WD = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  function parseYmd(ymd){
    if(!ymd) return null;
    const [y,m,d] = ymd.split("-").map(Number);
    if(!y||!m||!d) return null;
    const dt = new Date(y, m-1, d, 12,0,0);
    return isNaN(dt) ? null : dt;
  }
  function toYmd(dt){
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,"0");
    const d = String(dt.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  function labelFromYmd(ymd){
    const dt = parseYmd(ymd);
    if(!dt) return ymd || "";
    return `${dt.getMonth()+1}/${dt.getDate()}ï¼ˆ${WD[dt.getDay()]}ï¼‰`;
  }
  function iterYmdRange(startYmd, endYmd){
    const ds = parseYmd(startYmd), de = parseYmd(endYmd);
    if(!ds || !de || ds > de) return [];
    const out = [];
    const cur = new Date(ds);
    while(cur <= de){
      out.push(toYmd(cur));
      cur.setDate(cur.getDate()+1);
    }
    return out;
  }
  function syncDaysToMetaRange(d, {preserveExisting=true}={}){
    const range = iterYmdRange(d.meta?.start, d.meta?.end);
    if(!range.length){
      // keep as-is (no range)
      d.days = d.days || [];
      return;
    }

    d.days = d.days || [];
    // Normalize old days ymd (if missing, try infer by order)
    d.days.forEach((day, idx)=>{
      if(!day.ymd){
        const inferred = range[idx];
        if(inferred) day.ymd = inferred;
      }
      day.items = day.items || [];
      day.open = !!day.open;
      if(day.title == null) day.title = "ï¼ˆè«‹å¡«å¯«ä»Šå¤©ä¸»é¡Œï¼‰";
      if(day.meta == null) day.meta = "";
    });

    const oldByYmd = new Map();
    d.days.forEach(day=>{
      if(day.ymd) oldByYmd.set(day.ymd, day);
    });

    const newDays = range.map((ymd, i)=>{
      const old = preserveExisting ? oldByYmd.get(ymd) : null;
      if(old){
        old.ymd = ymd;
        return old;
      }
      return {
        id: `d${i+1}`,
        ymd,
        title: "ï¼ˆè«‹å¡«å¯«ä»Šå¤©ä¸»é¡Œï¼‰",
        meta: "",
        open: i===0,
        items: []
      };
    });

    // Reassign ids sequentially (stable UI)
    newDays.forEach((day, i)=> day.id = `d${i+1}`);
    d.days = newDays;

    // Also normalize each item: dateYmd/start/end/map
    d.days.forEach(day=>{
      day.items.forEach(it=>{
        if(!it.dateYmd) it.dateYmd = day.ymd;
        if(it.start == null) it.start = "";
        if(it.end == null) it.end = "";
        if(it.timeNote == null) it.timeNote = "";
        if(it.type == null) it.type = "visit";
        if(it.fixed == null) it.fixed = false;
        if(it.done == null) it.done = false;
        if(it.note == null) it.note = "";
        if(it.map == null) it.map = "";
        // Back-compat: old "time" -> start/end (best effort)
        if(it.time && !it.start && !it.end){
          const m = String(it.time).match(/^(\d{1,2}:\d{2})\s*[â€“-]\s*(\d{1,2}:\d{2})$/);
          if(m){ it.start = m[1]; it.end = m[2]; }
        }
      });
    });
  }

  // ===== Maps URL helper =====
  function normalizeMapLink(raw){
    const s = (raw || "").trim();
    if(!s) return "";
    if(/^https?:\/\//i.test(s)) return s;
    // treat as search query -> Google Maps URLs
    return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(s);
  }

  // =============================
  // Modal engine
  // =============================
  const modal = document.getElementById("modal");
  const modalForm = document.getElementById("modalForm");
  const modalTitle = document.getElementById("modalTitle");
  const modalFields = document.getElementById("modalFields");
  const modalClose = document.getElementById("modalClose");
  const modalCancel = document.getElementById("modalCancel");
  let modalOnSave = null;

  function supportsDialog(){ return typeof modal.showModal === "function"; }

  function openModal({title, fields, initial, onSave}){
    modalTitle.textContent = title || "ç·¨è¼¯";
    modalFields.innerHTML = "";
    modalOnSave = onSave || null;

    fields.forEach(f=>{
      const label = document.createElement("div");
      label.className = "mlabel";
      label.textContent = f.label || f.name;

      const cell = document.createElement("div");

      let el;
      if(f.type === "textarea"){
        el = document.createElement("textarea");
        el.className = "mtextarea";
        el.placeholder = f.placeholder || "";
        el.value = (initial && initial[f.name] != null) ? String(initial[f.name]) : (f.default || "");
        el.dataset.name = f.name;
        cell.appendChild(el);
      }else if(f.type === "select"){
        el = document.createElement("select");
        el.className = "mselect";
        (f.options || []).forEach(opt=>{
          const o = document.createElement("option");
          o.value = opt.value;
          o.textContent = opt.label;
          el.appendChild(o);
        });
        el.value = (initial && initial[f.name] != null) ? String(initial[f.name]) : (f.default || (f.options?.[0]?.value ?? ""));
        el.dataset.name = f.name;
        cell.appendChild(el);
      }else if(f.type === "checkbox"){
        label.textContent = "";
        const row = document.createElement("div");
        row.className = "mrow";
        const lb = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!(initial && initial[f.name] != null ? initial[f.name] : f.default);
        cb.dataset.name = f.name;
        lb.appendChild(cb);
        lb.appendChild(document.createTextNode(" " + (f.label || f.name)));
        row.appendChild(lb);
        cell.appendChild(row);
      }else if(f.type === "timeRange"){
        // Custom: start/end time pickers
        const row = document.createElement("div");
        row.className = "mrow";

        const start = document.createElement("input");
        start.className = "minput";
        start.type = "time";
        start.placeholder = "é–‹å§‹";
        start.value = (initial && initial[f.startName] != null) ? String(initial[f.startName]) : (f.startDefault || "");
        start.dataset.name = f.startName;

        const end = document.createElement("input");
        end.className = "minput";
        end.type = "time";
        end.placeholder = "çµæŸ";
        end.value = (initial && initial[f.endName] != null) ? String(initial[f.endName]) : (f.endDefault || "");
        end.dataset.name = f.endName;

        row.appendChild(start);
        row.appendChild(end);
        cell.appendChild(row);
      }else{
        el = document.createElement("input");
        el.className = "minput";
        el.type = f.type || "text";
        el.placeholder = f.placeholder || "";
        el.value = (initial && initial[f.name] != null) ? String(initial[f.name]) : (f.default || "");
        el.dataset.name = f.name;
        cell.appendChild(el);
      }

      modalFields.appendChild(label);
      modalFields.appendChild(cell);
    });

    if(supportsDialog()) modal.showModal();
    else modal.setAttribute("open", "");
  }

  function closeModal(){
    if(modal.open) modal.close();
    modalOnSave = null;
  }

  modalClose.addEventListener("click", closeModal);
  modalCancel.addEventListener("click", closeModal);
  modal.addEventListener("cancel", (e)=>{ e.preventDefault(); closeModal(); });

  modalForm.addEventListener("submit", (e)=>{
    e.preventDefault();
    const values = {};
    modalFields.querySelectorAll("[data-name]").forEach(el=>{
      const name = el.dataset.name;
      if(!name) return;
      if(el.type === "checkbox") values[name] = el.checked;
      else values[name] = el.value;
    });
    if(typeof modalOnSave === "function") modalOnSave(values);
    closeModal();
    renderAll();
  });

  // =============================
  // Rendering
  // =============================
  function renderHeader(d){
    document.title = d.meta.title || "Trip Planner";
    document.getElementById("titleText").textContent = d.meta.title || "Trip Planner";

    const extra = formatDateRange(d.meta);
    document.getElementById("subtitleText").textContent =
      extra ? `ç´”å‰ç«¯å–®æª”ï¼šå¯æœå°‹ã€å¯å‹¾é¸å®Œæˆã€å¯å¯«å‚™è¨»ã€å¯æ–°å¢/åˆªé™¤ä¸¦è‡ªå‹•ä¿å­˜ã€‚ï½œ${extra}` :
              "ç´”å‰ç«¯å–®æª”ï¼šå¯æœå°‹ã€å¯å‹¾é¸å®Œæˆã€å¯å¯«å‚™è¨»ã€å¯æ–°å¢/åˆªé™¤ä¸¦è‡ªå‹•ä¿å­˜ã€‚";

    const daysTitle = (d.meta.start && d.meta.end) ? `æ¯æ—¥è¡Œç¨‹ï¼ˆ${d.meta.start} â†’ ${d.meta.end}ï¼‰` : "æ¯æ—¥è¡Œç¨‹";
    document.getElementById("daysTitle").textContent = daysTitle;
  }

  function itemSearchText(parts){
    return (parts || []).filter(Boolean).join(" ").toLowerCase();
  }

  function displayTimeText(it){
    const s = (it.start || "").trim();
    const e = (it.end || "").trim();
    if(s && e) return `${s}â€“${e}`;
    if(s) return s;
    if(e) return e;
    return "";
  }

  function renderDisplayItem({
    leftTop, leftBottom, text, fixed, type, done, note, map,
    onToggleDone, onEdit, onDelete, searchText
  }){
    const box = document.createElement("div");
    box.className = "item cardItem";
    box.dataset.fixed = fixed ? "1" : "0";
    box.dataset.done  = done ? "1" : "0";
    box.dataset.text  = (searchText || "").toLowerCase();

    const time = document.createElement("div");
    time.className = "time";
    time.innerHTML = `
      <div>${escapeHtml(leftTop || "")}</div>
      <span class="small">${escapeHtml(leftBottom || "")}</span>
    `;

    const main = document.createElement("div");
    main.className = "main";

    const row1 = document.createElement("div");
    row1.className = "row1";

    const textEl = document.createElement("div");
    textEl.className = "text";
    textEl.textContent = text || "";

    const badges = document.createElement("div");
    badges.className = "badges";
    badges.appendChild(chipEl(fixed ? "å›ºå®š" : "å½ˆæ€§", fixed ? "fixed" : "flex"));
    badges.appendChild(chipEl(typeLabel(type), typeChipClass(type)));

    row1.appendChild(textEl);
    row1.appendChild(badges);

    const row2 = document.createElement("div");
    row2.className = "row2";

    const actions = document.createElement("div");
    actions.className = "actions";

    const doneCb = document.createElement("input");
    doneCb.type = "checkbox";
    doneCb.checked = !!done;
    doneCb.addEventListener("change", ()=> onToggleDone(doneCb.checked));

    const doneLb = document.createElement("label");
    doneLb.appendChild(doneCb);
    doneLb.appendChild(document.createTextNode(" å·²å®Œæˆ"));

    const editBtn = document.createElement("button");
    editBtn.type = "button";
    editBtn.className = "btnSmall btnAccent";
    editBtn.textContent = "âœç·¨è¼¯";
    editBtn.addEventListener("click", onEdit);

    const delBtn = document.createElement("button");
    delBtn.type = "button";
    delBtn.className = "btnSmall btnDanger";
    delBtn.textContent = "ğŸ—‘åˆªé™¤";
    delBtn.addEventListener("click", ()=>{
      if(confirmDanger("ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ")) onDelete();
    });

    actions.appendChild(doneLb);

    // Map icon if provided
    const mapLink = normalizeMapLink(map);
    if(mapLink){
      const mapBtn = document.createElement("button");
      mapBtn.type = "button";
      mapBtn.className = "mapBtn";
      mapBtn.title = "é–‹å•Ÿåœ°åœ–ï¼ˆGoogle Mapsï¼‰";
      mapBtn.setAttribute("aria-label", "é–‹å•Ÿåœ°åœ–");
      mapBtn.textContent = "ğŸ—º";
      mapBtn.addEventListener("click", ()=>{
        window.open(mapLink, "_blank", "noopener,noreferrer");
      });
      actions.appendChild(mapBtn);
    }

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);

    row2.appendChild(actions);

    main.appendChild(row1);
    main.appendChild(row2);

    if(note && note.trim()){
      const np = document.createElement("div");
      np.className = "notePreview";
      np.textContent = note.trim();
      main.appendChild(np);
    }

    box.appendChild(time);
    box.appendChild(main);

    return box;
  }

  function renderSettings(d){
    const root = document.getElementById("settings");
    root.innerHTML = "";

    const meta = d.meta || {};
    const locText = (meta.locations || []).join("ã€") || "ï¼ˆæœªè¨­å®šï¼‰";
    const dateText = (meta.start && meta.end) ? `${meta.start} â†’ ${meta.end}` : "ï¼ˆæœªè¨­å®šï¼‰";

    root.innerHTML = `
      <div class="twoCol">
        <div>
          <div class="item" style="grid-template-columns: 1fr;">
            <div class="main" style="gap:10px;">
              <div class="row1" style="align-items:center;">
                <div class="text"><span class="muted">æ¨™é¡Œï¼š</span>${escapeHtml(meta.title || "ï¼ˆæœªè¨­å®šï¼‰")}</div>
              </div>
              <div class="row1" style="align-items:center;">
                <div class="text"><span class="muted">æ—¥æœŸï¼š</span>${escapeHtml(dateText)}</div>
              </div>
              <div class="row1" style="align-items:center;">
                <div class="text"><span class="muted">åœ°é»ï¼š</span>${escapeHtml(locText)}</div>
              </div>
              <div class="footerHint">
                å„²å­˜æ—…éŠè¨­å®šå¾Œæœƒè‡ªå‹•åŒæ­¥ã€Œæ¯æ—¥è¡Œç¨‹ã€ï¼šè£œé½Šæ‰€æœ‰æ—¥æœŸå­æ¿å¡Šï¼ˆä¿ç•™æ—¢æœ‰è¡Œç¨‹ï¼‰ã€‚
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="item" style="grid-template-columns: 1fr;">
            <div class="main">
              <div class="text">æ–°å¢è¡Œç¨‹æ–¹å¼</div>
              <div class="footerHint">
                - åœ¨æŸä¸€å¤©å³ä¸Šè§’æŒ‰ã€Œï¼‹æ–°å¢ã€ï¼Œæœƒå‡ºç¾ï¼šæ—¥æœŸï¼ˆå¯æ›å¤©ï¼‰ï¼‹é–‹å§‹/çµæŸæ™‚é–“ï¼ˆé»é¸å¼ï¼‰ï¼‹åœ°åœ–é€£çµã€‚<br/>
                - åœ°åœ–é€£çµå¯è²¼ç¶²å€ï¼Œæˆ–ç›´æ¥è¼¸å…¥åœ°é»é—œéµå­—ï¼ˆæœƒè‡ªå‹•ç”¨ Google Maps æœå°‹é€£çµï¼‰ã€‚
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function openMetaModal(){
    const d = loadData();
    openModal({
      title: "ç·¨è¼¯æ—…éŠè¨­å®š",
      initial: {
        title: d.meta.title || "",
        start: d.meta.start || "",
        end: d.meta.end || "",
        locations: (d.meta.locations || []).join(", ")
      },
      fields: [
        {name:"title", label:"æ¨™é¡Œ", type:"text", placeholder:"ä¾‹å¦‚ï¼š10/27â€“11/1 è¡Œç¨‹è¡¨ï¼ˆåŸå¸‚â€¦ï¼‰"},
        {name:"start", label:"é–‹å§‹æ—¥æœŸ", type:"date"},
        {name:"end", label:"çµæŸæ—¥æœŸ", type:"date"},
        {name:"locations", label:"æ—…éŠåœ°é»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰", type:"text", placeholder:"æ­å·, è˜‡å·, ä¸Šæµ·"}
      ],
      onSave: (v)=>{
        const nd = loadData();
        nd.meta.title = (v.title || "").trim() || "Trip Planner";
        nd.meta.start = v.start || "";
        nd.meta.end = v.end || "";
        nd.meta.locations = sanitizeLocationsInput(v.locations || "");

        // Save + sync days immediately after confirmation
        syncDaysToMetaRange(nd, {preserveExisting:true});
        saveData(nd);
      }
    });
  }

  function openFixedModal(existingId=null){
    const d = loadData();
    const ex = existingId ? d.fixed.find(x=>x.id===existingId) : null;

    openModal({
      title: existingId ? "ç·¨è¼¯ï¼ˆäº¤é€š/ä½å®¿ï¼‰" : "æ–°å¢ï¼ˆäº¤é€š/ä½å®¿ï¼‰",
      initial: ex ? {
        dateText: ex.dateText || "",
        kind: ex.kind || "",
        text: ex.text || "",
        type: ex.type || "transport",
        fixed: ex.fixed !== false,
        done: !!ex.done,
        note: ex.note || "",
        map: ex.map || ""
      } : {
        dateText: "",
        kind: "èˆªç­",
        text: "",
        type: "flight",
        fixed: true,
        done: false,
        note: "",
        map: ""
      },
      fields: [
        {name:"dateText", label:"æ—¥æœŸ/æ™‚é–“ï¼ˆå·¦å´é¡¯ç¤ºï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼š10/27ï¼ˆäºŒï¼‰æˆ– 11:50â€“13:55"},
        {name:"kind", label:"é¡åˆ¥ï¼ˆå·¦ä¸‹å°å­—ï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼šèˆªç­ / ä½å®¿ / äº¤é€š"},
        {name:"text", label:"å…§å®¹", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šHX253ï¼šTPE 11:50 â†’ HKG 13:55"},
        {name:"map", label:"åœ°åœ–é€£çµï¼ˆå¯è²¼ç¶²å€æˆ–è¼¸å…¥åœ°é»ï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼šhttps://maps.google.com/... æˆ– å°åŒ—æ¡ƒåœ’æ©Ÿå ´ TPE"},
        {name:"type", label:"æ¨™ç±¤é¡å‹", type:"select", options:[
          {value:"flight", label:"èˆªç­"},
          {value:"transport", label:"äº¤é€š"},
          {value:"hotel", label:"ä½å®¿"},
          {value:"other", label:"å…¶ä»–"}
        ]},
        {name:"fixed", label:"å›ºå®šï¼ˆä¸å¯å‹•ï¼‰", type:"checkbox", default:true},
        {name:"done", label:"å·²å®Œæˆ", type:"checkbox", default:false},
        {name:"note", label:"å‚™è¨»", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šè¨‚ä½ä»£è™Ÿ / èˆªå»ˆ / é›†åˆé»â€¦"}
      ],
      onSave: (v)=>{
        const nd = loadData();
        if(existingId){
          const it = nd.fixed.find(x=>x.id===existingId);
          if(!it) return;
          it.dateText = v.dateText || "";
          it.kind = v.kind || "";
          it.text = v.text || "";
          it.map = v.map || "";
          it.type = v.type || "other";
          it.fixed = !!v.fixed;
          it.done = !!v.done;
          it.note = v.note || "";
        }else{
          nd.fixed.push({
            id: uid("fx"),
            dateText: v.dateText || "",
            kind: v.kind || "äº¤é€š/ä½å®¿",
            text: v.text || "",
            map: v.map || "",
            type: v.type || "other",
            fixed: !!v.fixed,
            done: !!v.done,
            note: v.note || ""
          });
        }
        saveData(nd);
      }
    });
  }

  function openDayMetaModal(dayId){
    const d = loadData();
    const day = d.days.find(x=>x.id===dayId);
    if(!day) return;

    openModal({
      title: "ç·¨è¼¯ï¼ˆç•¶å¤©è³‡è¨Šï¼‰",
      initial: { title: day.title || "", meta: day.meta || "" },
      fields: [
        {name:"title", label:"ç•¶å¤©æ¨™é¡Œ", type:"text", placeholder:"ä¾‹å¦‚ï¼šæ­å·ï¼šè¥¿æ¹–ï¼‹å¤œå¸‚"},
        {name:"meta", label:"å³å´å°å­—ï¼ˆå¯ç©ºç™½ï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼šé€€æˆ¿ï¼‹ç§»å‹•æ—¥"}
      ],
      onSave: (v)=>{
        const nd = loadData();
        const dd = nd.days.find(x=>x.id===dayId);
        if(!dd) return;
        dd.title = (v.title || "").trim();
        dd.meta = (v.meta || "").trim();
        saveData(nd);
      }
    });
  }

  function ensureDayExistsByYmd(d, ymd){
    if(!ymd) return null;
    const existing = d.days.find(x=>x.ymd===ymd);
    if(existing) return existing;

    // only allow within current meta range; otherwise ask user to update meta
    const range = iterYmdRange(d.meta?.start, d.meta?.end);
    if(range.length && !range.includes(ymd)) return null;

    // Create missing day, then sort by ymd
    const day = {
      id: uid("d"),
      ymd,
      title: "ï¼ˆè«‹å¡«å¯«ä»Šå¤©ä¸»é¡Œï¼‰",
      meta: "",
      open: false,
      items: []
    };
    d.days.push(day);
    d.days.sort((a,b)=> (a.ymd||"").localeCompare(b.ymd||""));
    // Reassign ids sequentially
    d.days.forEach((x,i)=> x.id = `d${i+1}`);
    return d.days.find(x=>x.ymd===ymd);
  }

  function openDayItemModal(dayId, itemId=null){
    const d = loadData();
    const day = d.days.find(x=>x.id===dayId);
    if(!day) return;

    const ex = itemId ? day.items.find(x=>x.id===itemId) : null;

    openModal({
      title: itemId ? "ç·¨è¼¯ï¼ˆè¡Œç¨‹é …ç›®ï¼‰" : "æ–°å¢ï¼ˆè¡Œç¨‹é …ç›®ï¼‰",
      initial: ex ? {
        dateYmd: ex.dateYmd || day.ymd,
        start: ex.start || "",
        end: ex.end || "",
        timeNote: ex.timeNote || "",
        text: ex.text || "",
        type: ex.type || "visit",
        fixed: !!ex.fixed,
        done: !!ex.done,
        note: ex.note || "",
        map: ex.map || ""
      } : {
        dateYmd: day.ymd,
        start: "",
        end: "",
        timeNote: "",
        text: "",
        type: "visit",
        fixed: false,
        done: false,
        note: "",
        map: ""
      },
      fields: [
        {name:"dateYmd", label:"æ—¥æœŸï¼ˆé»é¸ï¼‰", type:"date"},
        {name:"timeRange", label:"æ™‚é–“ï¼ˆé»é¸ï¼šé–‹å§‹ / çµæŸï¼‰", type:"timeRange", startName:"start", endName:"end"},
        {name:"timeNote", label:"æ™‚é–“å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼šå›ºå®š / å½ˆæ€§ / éœ€é ç´„"},
        {name:"text", label:"å…§å®¹", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šè¥¿æ¹–æ•£æ­¥ï¼ˆæ—©ä¸Šå…‰ç·šè¼ƒæŸ”ï¼‰"},
        {name:"map", label:"åœ°åœ–é€£çµï¼ˆå¯è²¼ç¶²å€æˆ–è¼¸å…¥åœ°é»ï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼šè±«åœ’ æˆ– https://maps.google.com/..."},
        {name:"type", label:"æ¨™ç±¤é¡å‹", type:"select", options:[
          {value:"visit", label:"æ™¯é»"},
          {value:"food", label:"åƒé£¯"},
          {value:"transport", label:"äº¤é€š"},
          {value:"hotel", label:"ä½å®¿"},
          {value:"flight", label:"èˆªç­"},
          {value:"rule", label:"è¦å‰‡"},
          {value:"other", label:"å…¶ä»–"}
        ]},
        {name:"fixed", label:"å›ºå®šï¼ˆä¸å¯å‹•ï¼‰", type:"checkbox", default:false},
        {name:"done", label:"å·²å®Œæˆ", type:"checkbox", default:false},
        {name:"note", label:"å‚™è¨»", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šé›†åˆé» / é–€ç¥¨ / æ›¿ä»£æ–¹æ¡ˆâ€¦"}
      ],
      onSave: (v)=>{
        const nd = loadData();

        // Validate date
        const ymd = v.dateYmd || "";
        const targetDay = ensureDayExistsByYmd(nd, ymd);
        if(!targetDay){
          alert("ä½ é¸çš„æ—¥æœŸä¸åœ¨æ—…éŠè¨­å®šçš„æ—¥æœŸç¯„åœå…§ã€‚\nè«‹å…ˆåˆ°ã€æ—…éŠè¨­å®šã€ä¿®æ”¹é–‹å§‹/çµæŸæ—¥æœŸå¾Œå†æ–°å¢è¡Œç¨‹ã€‚");
          return;
        }

        // Editing: might move to another day
        if(itemId){
          // find original
          const fromDay = nd.days.find(x=>x.id===dayId);
          if(!fromDay) return;
          const old = fromDay.items.find(x=>x.id===itemId);
          if(!old) return;

          // remove from old container if moved
          if(old.dateYmd && old.dateYmd !== ymd){
            fromDay.items = fromDay.items.filter(x=>x.id!==itemId);
            targetDay.items.push(old);
          }

          old.dateYmd = ymd;
          old.start = v.start || "";
          old.end = v.end || "";
          old.timeNote = v.timeNote || "";
          old.text = v.text || "";
          old.map = v.map || "";
          old.type = v.type || "other";
          old.fixed = !!v.fixed;
          old.done = !!v.done;
          old.note = v.note || "";
        }else{
          targetDay.items.push({
            id: uid("it"),
            dateYmd: ymd,
            start: v.start || "",
            end: v.end || "",
            timeNote: v.timeNote || "",
            text: v.text || "",
            map: v.map || "",
            type: v.type || "other",
            fixed: !!v.fixed,
            done: !!v.done,
            note: v.note || ""
          });
        }
        saveData(nd);
      }
    });
  }

  function renderFixed(d){
    const root = document.getElementById("fixedList");
    root.innerHTML = "";

    const itemsWrap = document.createElement("div");
    itemsWrap.className = "items";
    itemsWrap.style.padding = "0";

    if(!d.fixed.length){
      const empty = document.createElement("div");
      empty.className = "footerHint";
      empty.textContent = "å°šç„¡äº¤é€š/ä½å®¿é …ç›®ï¼ŒæŒ‰å³ä¸Šè§’ã€Œï¼‹æ–°å¢ã€ã€‚";
      root.appendChild(empty);
    }

    d.fixed.forEach(fx=>{
      const search = itemSearchText([fx.dateText, fx.kind, fx.text, fx.note, fx.type, fx.map]);
      const box = renderDisplayItem({
        leftTop: fx.dateText || "",
        leftBottom: fx.kind || "",
        text: fx.text || "",
        fixed: fx.fixed !== false,
        type: fx.type || "other",
        done: !!fx.done,
        note: fx.note || "",
        map: fx.map || "",
        searchText: search,
        onToggleDone: (checked)=>{
          const nd = loadData();
          const it = nd.fixed.find(x=>x.id===fx.id);
          if(!it) return;
          it.done = checked;
          saveData(nd);
          applyFilter();
        },
        onEdit: ()=> openFixedModal(fx.id),
        onDelete: ()=>{
          const nd = loadData();
          nd.fixed = nd.fixed.filter(x=>x.id!==fx.id);
          saveData(nd);
          renderAll();
        }
      });
      itemsWrap.appendChild(box);
    });

    root.appendChild(itemsWrap);
  }

  function renderDays(d){
    const root = document.getElementById("days");
    root.innerHTML = "";

    if(!d.days.length){
      const pad = document.createElement("div");
      pad.className = "cardBody";
      pad.innerHTML = `<div class="footerHint">å°šç„¡æ¯æ—¥è¡Œç¨‹ã€‚è«‹å…ˆåˆ°ã€æ—…éŠè¨­å®šã€å¡«é–‹å§‹/çµæŸæ—¥æœŸä¸¦å„²å­˜ã€‚</div>`;
      root.appendChild(pad);
      return;
    }

    d.days.forEach(day=>{
      const details = document.createElement("details");
      details.className = "day";
      details.open = !!day.open;

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "dayTitle";

      const dateTag = document.createElement("span");
      dateTag.className = "d";
      dateTag.textContent = labelFromYmd(day.ymd);

      const title = document.createElement("span");
      title.className = "t";
      title.textContent = day.title || "";

      left.appendChild(dateTag);
      left.appendChild(title);

      const right = document.createElement("div");
      right.className = "dayMeta";

      const meta = document.createElement("span");
      meta.textContent = day.meta || "";

      const btnEditDay = document.createElement("button");
      btnEditDay.type = "button";
      btnEditDay.className = "btnSmall";
      btnEditDay.textContent = "âœç·¨è¼¯";
      btnEditDay.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openDayMetaModal(day.id);
      });

      const btnAdd = document.createElement("button");
      btnAdd.type = "button";
      btnAdd.className = "btnSmall btnAccent";
      btnAdd.textContent = "ï¼‹æ–°å¢";
      btnAdd.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openDayItemModal(day.id, null);
      });

      right.appendChild(meta);
      right.appendChild(btnEditDay);
      right.appendChild(btnAdd);

      sum.appendChild(left);
      sum.appendChild(right);
      details.appendChild(sum);

      details.addEventListener("toggle", ()=>{
        const nd = loadData();
        const dd = nd.days.find(x=>x.id===day.id);
        if(!dd) return;
        dd.open = details.open;
        saveData(nd);
      });

      const items = document.createElement("div");
      items.className = "items";

      if(!day.items.length){
        const empty = document.createElement("div");
        empty.className = "footerHint";
        empty.textContent = "ä»Šå¤©é‚„æ²’æœ‰é …ç›®ï¼ŒæŒ‰å³ä¸Šè§’ã€Œï¼‹æ–°å¢ã€ã€‚";
        items.appendChild(empty);
      }

      day.items.forEach(it=>{
        const leftTop = displayTimeText(it);
        const leftBottom = it.timeNote || "";
        const search = itemSearchText([
          day.ymd, labelFromYmd(day.ymd), day.title, day.meta,
          it.start, it.end, it.timeNote, it.text, it.note, it.type, it.map
        ]);

        const box = renderDisplayItem({
          leftTop,
          leftBottom,
          text: it.text || "",
          fixed: !!it.fixed,
          type: it.type || "other",
          done: !!it.done,
          note: it.note || "",
          map: it.map || "",
          searchText: search,
          onToggleDone: (checked)=>{
            const nd = loadData();
            const dd = nd.days.find(x=>x.id===day.id);
            if(!dd) return;
            const item = dd.items.find(x=>x.id===it.id);
            if(!item) return;
            item.done = checked;
            saveData(nd);
            applyFilter();
          },
          onEdit: ()=> openDayItemModal(day.id, it.id),
          onDelete: ()=>{
            const nd = loadData();
            const dd = nd.days.find(x=>x.id===day.id);
            if(!dd) return;
            dd.items = dd.items.filter(x=>x.id!==it.id);
            saveData(nd);
            renderAll();
          }
        });
        items.appendChild(box);
      });

      details.appendChild(items);
      root.appendChild(details);
    });
  }

  function openReminderModal(existingId=null){
    const d = loadData();
    const ex = existingId ? d.reminders.find(x=>x.id===existingId) : null;

    openModal({
      title: existingId ? "ç·¨è¼¯ï¼ˆæé†’äº‹é …ï¼‰" : "æ–°å¢ï¼ˆæé†’äº‹é …ï¼‰",
      initial: ex ? {
        text: ex.text || "",
        fixed: !!ex.fixed,
        done: !!ex.done,
        note: ex.note || "",
        map: ex.map || ""
      } : {
        text: "",
        fixed: false,
        done: false,
        note: "",
        map: ""
      },
      fields: [
        {name:"text", label:"æé†’å…§å®¹", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šå‡ºç™¼å‰ä¸€å¤©ç¢ºèªèˆªç­ã€å……é›»ã€ä¿éšªâ€¦"},
        {name:"map", label:"åœ°åœ–é€£çµï¼ˆå¯é¸ï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼šé›†åˆé»åœ°åœ–é€£çµæˆ–é—œéµå­—"},
        {name:"fixed", label:"å›ºå®šï¼ˆé‡è¦ï¼‰", type:"checkbox", default:false},
        {name:"done", label:"å·²å®Œæˆ", type:"checkbox", default:false},
        {name:"note", label:"å‚™è¨»", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šè¦å¸¶ä»€éº¼ã€ä½•æ™‚åšã€æ›¿ä»£æ–¹æ¡ˆâ€¦"}
      ],
      onSave: (v)=>{
        const nd = loadData();
        if(existingId){
          const it = nd.reminders.find(x=>x.id===existingId);
          if(!it) return;
          it.text = v.text || "";
          it.map = v.map || "";
          it.fixed = !!v.fixed;
          it.done = !!v.done;
          it.note = v.note || "";
        }else{
          nd.reminders.push({
            id: uid("rm"),
            text: v.text || "",
            map: v.map || "",
            fixed: !!v.fixed,
            type: "reminder",
            done: !!v.done,
            note: v.note || ""
          });
        }
        saveData(nd);
      }
    });
  }

  function renderReminders(d){
    const root = document.getElementById("reminders");
    root.innerHTML = "";

    const itemsWrap = document.createElement("div");
    itemsWrap.className = "items";
    itemsWrap.style.padding = "0";

    if(!d.reminders.length){
      const empty = document.createElement("div");
      empty.className = "footerHint";
      empty.textContent = "å°šç„¡æé†’äº‹é …ï¼ŒæŒ‰å³ä¸Šè§’ã€Œï¼‹æ–°å¢ã€ã€‚";
      root.appendChild(empty);
    }

    d.reminders.forEach(rm=>{
      const search = itemSearchText([rm.text, rm.note, rm.map, "reminder"]);
      const box = renderDisplayItem({
        leftTop: "æé†’",
        leftBottom: rm.fixed ? "å›ºå®š" : "å½ˆæ€§",
        text: rm.text || "",
        fixed: !!rm.fixed,
        type: "reminder",
        done: !!rm.done,
        note: rm.note || "",
        map: rm.map || "",
        searchText: search,
        onToggleDone: (checked)=>{
          const nd = loadData();
          const it = nd.reminders.find(x=>x.id===rm.id);
          if(!it) return;
          it.done = checked;
          saveData(nd);
          applyFilter();
        },
        onEdit: ()=> openReminderModal(rm.id),
        onDelete: ()=>{
          const nd = loadData();
          nd.reminders = nd.reminders.filter(x=>x.id!==rm.id);
          saveData(nd);
          renderAll();
        }
      });
      itemsWrap.appendChild(box);
    });

    root.appendChild(itemsWrap);
  }

  function openRestaurantModal(existingId=null){
    const d = loadData();
    const ex = existingId ? d.restaurants.find(x=>x.id===existingId) : null;

    openModal({
      title: existingId ? "ç·¨è¼¯ï¼ˆé¤å»³ï¼‰" : "æ–°å¢ï¼ˆé¤å»³ï¼‰",
      initial: ex ? {
        city: ex.city || "",
        name: ex.name || "",
        map: ex.map || "",
        fixed: !!ex.fixed,
        done: !!ex.done,
        note: ex.note || ""
      } : {
        city: "",
        name: "",
        map: "",
        fixed: false,
        done: false,
        note: ""
      },
      fields: [
        {name:"city", label:"åŸå¸‚", type:"text", placeholder:"ä¾‹å¦‚ï¼šæ­å· / è˜‡å· / ä¸Šæµ·"},
        {name:"name", label:"é¤å»³åç¨±", type:"text", placeholder:"ä¾‹å¦‚ï¼šStarbucks Reserve Roastery"},
        {name:"map", label:"åœ°åœ–é€£çµï¼ˆå¯è²¼ç¶²å€æˆ–è¼¸å…¥åœ°é»ï¼‰", type:"text", placeholder:"ä¾‹å¦‚ï¼šåº—å + åŸå¸‚ï¼Œæˆ–è²¼ Google Maps é€£çµ"},
        {name:"fixed", label:"å›ºå®šï¼ˆå¿…åƒï¼‰", type:"checkbox", default:false},
        {name:"done", label:"å·²å®Œæˆ", type:"checkbox", default:false},
        {name:"note", label:"å‚™è¨»", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šæƒ³é»ä»€éº¼ã€æ’éšŠç­–ç•¥ã€è¨‚ä½â€¦"}
      ],
      onSave: (v)=>{
        const nd = loadData();
        if(existingId){
          const it = nd.restaurants.find(x=>x.id===existingId);
          if(!it) return;
          it.city = v.city || "";
          it.name = v.name || "";
          it.map = v.map || "";
          it.fixed = !!v.fixed;
          it.done = !!v.done;
          it.note = v.note || "";
        }else{
          nd.restaurants.push({
            id: uid("rs"),
            city: v.city || "",
            name: v.name || "",
            map: v.map || "",
            fixed: !!v.fixed,
            type: "food",
            done: !!v.done,
            note: v.note || ""
          });
        }
        saveData(nd);
      }
    });
  }

  function renderFood(d){
    const root = document.getElementById("food");
    root.innerHTML = "";

    const wrap = document.createElement("div");
    wrap.className = "twoCol";

    const left = document.createElement("div");
    left.innerHTML = `<div class="muted" style="font-size:12px; margin-bottom:8px;">æ¸…å–®</div>`;

    const list = document.createElement("div");
    list.style.display = "flex";
    list.style.flexDirection = "column";
    list.style.gap = "10px";

    if(!d.restaurants.length){
      const empty = document.createElement("div");
      empty.className = "footerHint";
      empty.textContent = "å°šç„¡é¤å»³æ¸…å–®ï¼ŒæŒ‰å³ä¸Šè§’ã€Œï¼‹æ–°å¢ã€ã€‚";
      list.appendChild(empty);
    }

    d.restaurants.forEach(r=>{
      const search = itemSearchText([r.city, r.name, r.note, r.map, "food"]);
      const box = renderDisplayItem({
        leftTop: r.city || "",
        leftBottom: "é¤å»³",
        text: r.name || "",
        fixed: !!r.fixed,
        type: "food",
        done: !!r.done,
        note: r.note || "",
        map: r.map || "",
        searchText: search,
        onToggleDone: (checked)=>{
          const nd = loadData();
          const it = nd.restaurants.find(x=>x.id===r.id);
          if(!it) return;
          it.done = checked;
          saveData(nd);
          applyFilter();
        },
        onEdit: ()=> openRestaurantModal(r.id),
        onDelete: ()=>{
          const nd = loadData();
          nd.restaurants = nd.restaurants.filter(x=>x.id!==r.id);
          saveData(nd);
          renderAll();
        }
      });
      list.appendChild(box);
    });

    left.appendChild(list);

    const right = document.createElement("div");
    right.innerHTML = `
      <div class="muted" style="font-size:12px; margin-bottom:8px;">é¤å»³å‚™è¨»ï¼ˆæ•´é«”ï¼‰</div>
      <div class="item" style="grid-template-columns: 1fr;">
        <div class="main">
          <div class="text">${escapeHtml((d.restaurantsNote||"").trim() ? d.restaurantsNote : "ï¼ˆå°šç„¡ï¼‰")}</div>
          <div class="actions" style="justify-content:flex-end; margin-top:6px;">
            <button id="editRestaurantsNote" class="btnSmall btnAccent" type="button">âœç·¨è¼¯</button>
          </div>
        </div>
      </div>
    `;

    wrap.appendChild(left);
    wrap.appendChild(right);
    root.appendChild(wrap);

    document.getElementById("editRestaurantsNote").addEventListener("click", ()=>{
      const dd = loadData();
      openModal({
        title: "ç·¨è¼¯ï¼ˆé¤å»³å‚™è¨»-æ•´é«”ï¼‰",
        initial: { note: dd.restaurantsNote || "" },
        fields: [{name:"note", label:"å‚™è¨»", type:"textarea", placeholder:"ä¾‹å¦‚ï¼šæ¨è–¦èœ / è¨‚ä½ç­–ç•¥ / å“ªå¤©å®‰æ’æ¯”è¼ƒé †â€¦"}],
        onSave: (v)=>{
          const nd = loadData();
          nd.restaurantsNote = v.note || "";
          saveData(nd);
        }
      });
    });
  }

  // =============================
  // Filter / UI actions
  // =============================
  function applyFilter(){
    const q = (document.getElementById("q").value || "").trim().toLowerCase();
    const onlyFixed = document.getElementById("onlyFixed").checked;
    const onlyFlex  = document.getElementById("onlyFlex").checked;
    const onlyTodo  = document.getElementById("onlyTodo").checked;

    const items = document.querySelectorAll(".cardItem");
    items.forEach(el=>{
      const isFixed = el.dataset.fixed === "1";
      const isDone  = el.dataset.done === "1";
      const text = el.dataset.text || "";
      let ok = true;

      if(q && !text.includes(q)) ok = false;
      if(onlyFixed && !isFixed) ok = false;
      if(onlyFlex && isFixed) ok = false;
      if(onlyTodo && isDone) ok = false;

      el.style.display = ok ? "" : "none";
    });

    document.querySelectorAll("details.day").forEach(d=>{
      const visibleCount = Array.from(d.querySelectorAll(".cardItem")).filter(x => x.style.display !== "none").length;
      d.style.opacity = visibleCount ? "1" : ".45";
    });
  }

  function expandAll(open){
    const nd = loadData();
    nd.days.forEach(x=> x.open = open);
    saveData(nd);
    document.querySelectorAll("details.day").forEach(d=> d.open = open);
  }

  function clearDoneNoteOnly(){
    const nd = loadData();
    nd.fixed.forEach(x=>{ x.done=false; x.note=""; });
    nd.days.forEach(day=> day.items.forEach(it=>{ it.done=false; it.note=""; }));
    nd.reminders.forEach(x=>{ x.done=false; x.note=""; });
    nd.restaurants.forEach(x=>{ x.done=false; x.note=""; });
    saveData(nd);
    renderAll();
  }

  function resetAllToDefault(){
    localStorage.removeItem(KEY_DATA);
    renderAll();
  }

  // =============================
  // Init + Bindings
  // =============================
  function renderAll(){
    const d = loadData();
    renderHeader(d);
    renderSettings(d);
    renderFixed(d);
    renderDays(d);
    renderReminders(d);
    renderFood(d);
    applyFilter();
  }

  document.getElementById("q").addEventListener("input", applyFilter);

  document.getElementById("onlyFixed").addEventListener("change", ()=>{
    if(document.getElementById("onlyFixed").checked) document.getElementById("onlyFlex").checked = false;
    applyFilter();
  });
  document.getElementById("onlyFlex").addEventListener("change", ()=>{
    if(document.getElementById("onlyFlex").checked) document.getElementById("onlyFixed").checked = false;
    applyFilter();
  });
  document.getElementById("onlyTodo").addEventListener("change", applyFilter);

  document.getElementById("expandAll").addEventListener("click", ()=>expandAll(true));
  document.getElementById("collapseAll").addEventListener("click", ()=>expandAll(false));
  document.getElementById("print").addEventListener("click", ()=>window.print());

  document.getElementById("resetDoneNote").addEventListener("click", ()=>{
    if(confirmDanger("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å‹¾é¸èˆ‡å‚™è¨»å—ï¼Ÿï¼ˆä¿ç•™æ¸…å–®æ–‡å­—å…§å®¹ï¼‰")){
      clearDoneNoteOnly();
    }
  });

  document.getElementById("resetAll").addEventListener("click", ()=>{
    if(confirmDanger("ç¢ºå®šè¦ã€é‡è¨­å…¨éƒ¨ã€å›åˆ°é è¨­æ¨¡æ¿å—ï¼Ÿï¼ˆåŒ…å«ä½ æ–°å¢/ä¿®æ”¹çš„æ‰€æœ‰å…§å®¹éƒ½æœƒæ¶ˆå¤±ï¼‰")){
      resetAllToDefault();
    }
  });

  document.getElementById("addFixed").addEventListener("click", ()=> openFixedModal(null));
  document.getElementById("addReminder").addEventListener("click", ()=> openReminderModal(null));
  document.getElementById("addRestaurant").addEventListener("click", ()=> openRestaurantModal(null));

  document.getElementById("editMetaTop").addEventListener("click", openMetaModal);
  document.getElementById("editMetaCard").addEventListener("click", openMetaModal);

  renderAll();
</script>
</body>
</html>
